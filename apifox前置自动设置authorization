// Pre-request Scriptï¼ˆå¼‚æ­¥ç‰ˆï¼Œé€‚é…å®é™…ç™»å½•å“åº”ï¼Œè§£å†³è¿‡æœŸæ—¶é—´ä¸å‡†ï¼‰

// è·å–ç¯å¢ƒå˜é‡ä¸­çš„Tokenå’Œè¿‡æœŸæ—¶é—´ï¼ˆç»Ÿä¸€è½¬ä¸ºNumberç±»å‹ï¼Œé¿å…æ¯”è¾ƒé”™è¯¯ï¼‰
const accessToken = pm.environment.get("ACCESS_TOKEN");
let accessTokenExpires = Number(pm.environment.get("ACCESS_TOKEN_EXPIRES")) || 0;

// æ ¸å¿ƒé…ç½®ï¼ˆæ ¹æ®ä½ çš„å®é™…æ¥å£å“åº”è°ƒæ•´ï¼Œå½“å‰å·²é€‚é…ï¼ï¼‰
const TOKEN_DEFAULT_EXPIRE_HOURS = 2; // Tokené»˜è®¤æœ‰æ•ˆæœŸï¼ˆ2å°æ—¶ï¼Œå¯æ ¹æ®æ¥å£å®é™…è§„åˆ™ä¿®æ”¹ï¼‰
const TIME_OFFSET_TOLERANCE = 60; // æ—¶é—´åå·®å®¹å¿åº¦ï¼ˆ60ç§’ï¼Œé¿å…æœåŠ¡å™¨ä¸æœ¬åœ°æ—¶é—´å·®å¯¼è‡´æå‰è¿‡æœŸï¼‰
const MIN_EXPIRE_SECONDS = 300; // æœ€å°æœ‰æ•ˆæœŸï¼ˆ5åˆ†é’Ÿï¼Œé˜²æ­¢å¼‚å¸¸å€¼ï¼‰
const MAX_EXPIRE_SECONDS = 86400; // æœ€å¤§æœ‰æ•ˆæœŸï¼ˆ24å°æ—¶ï¼Œé˜²æ­¢å¼‚å¸¸å€¼ï¼‰

// å®šä¹‰ç™»å½•è¯·æ±‚æ–¹æ³•ï¼ˆå¼‚æ­¥ï¼Œä¸¥æ ¼åŒ¹é…ä½ çš„æ¥å£å“åº”æ ¼å¼ï¼‰
async function sendLoginRequest() {
    console.log("Tokenä¸å­˜åœ¨/å·²è¿‡æœŸï¼Œæ­£åœ¨è°ƒç”¨ç™»å½•æ¥å£...");

    const loginRequest = {
        url: "http://mark-api.com/v1/GameConfigApi/game_user_login?xxxx",
        method: "GET"
    };

    return new Promise((resolve, reject) => {
        pm.sendRequest(loginRequest, (err, response) => {
            if (err) {
                console.error("ç™»å½•è¯·æ±‚ç½‘ç»œå¤±è´¥:", err);
                reject(new Error(`ç½‘ç»œé”™è¯¯ï¼š${err.message}`));
                return;
            }

            try {
                const jsonData = response.json();
                console.log("ç™»å½•æ¥å£è¿”å›:", jsonData);

                // æ ¡éªŒå“åº”æ ¼å¼ï¼ˆä¸¥æ ¼åŒ¹é…ä½ çš„æ¥å£ï¼šstatus=1 + dataå­˜åœ¨ + data.tokenå­˜åœ¨ï¼‰
                if (jsonData.status !== 1 || !jsonData.data || !jsonData.data.token) {
                    reject(new Error(`ç™»å½•æ¥å£è¿”å›å¼‚å¸¸ï¼Œå“åº”: ${JSON.stringify(jsonData)}`));
                    return;
                }

                // æå–å…³é”®æ•°æ®ï¼ˆå®Œå…¨åŒ¹é…ä½ çš„å“åº”å­—æ®µï¼‰
                const newAccessToken = jsonData.data.token; // ä»data.tokenæå–Token
                const serverTime = Number(jsonData.server_time) || new Date().getTime(); // æå–æœåŠ¡å™¨æ—¶é—´

                // è®¡ç®—è¿‡æœŸæ—¶é—´ï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼šæœåŠ¡å™¨æ—¶é—´+é»˜è®¤æœ‰æ•ˆæœŸ-å®¹å¿åº¦ï¼‰
                let expireSeconds = TOKEN_DEFAULT_EXPIRE_HOURS * 3600; // è½¬ä¸ºç§’
                // æ ¡æ­£è¿‡æœŸæ—¶é•¿ï¼ˆé¿å…é…ç½®é”™è¯¯å¯¼è‡´çš„å¼‚å¸¸ï¼‰
                expireSeconds = Math.max(MIN_EXPIRE_SECONDS, Math.min(expireSeconds, MAX_EXPIRE_SECONDS));
                // æœ€ç»ˆè¿‡æœŸæ—¶é—´ = æœåŠ¡å™¨æ—¶é—´ + æœ‰æ•ˆæ—¶é•¿ - å®¹å¿åº¦ï¼ˆé˜²æ­¢æ—¶é—´åå·®ï¼‰
                const newExpires = serverTime + (expireSeconds - TIME_OFFSET_TOLERANCE) * 1000;

                // å†™å…¥ç¯å¢ƒå˜é‡ï¼ˆå­˜ä¸ºNumberç±»å‹ï¼Œé¿å…åç»­æ¯”è¾ƒé”™è¯¯ï¼‰
                pm.environment.set("ACCESS_TOKEN", newAccessToken);
                pm.environment.set("ACCESS_TOKEN_EXPIRES", newExpires);

                // è¯¦ç»†æ—¥å¿—ï¼ˆä¾¿äºè°ƒè¯•ï¼ŒæŸ¥çœ‹å…³é”®æ—¶é—´ï¼‰
                console.log("âœ… Tokenå·²åˆ·æ–°:", newAccessToken);
                console.log("ğŸ“… æœåŠ¡å™¨æ—¶é—´:", new Date(serverTime).toLocaleString());
                console.log("â³ Tokenæœ‰æ•ˆæœŸ:", TOKEN_DEFAULT_EXPIRE_HOURS, "å°æ—¶ï¼ˆé…ç½®å€¼ï¼‰");
                console.log("â° Tokenå®é™…è¿‡æœŸæ—¶é—´:", new Date(newExpires).toLocaleString());

                resolve(newAccessToken);
            } catch (parseErr) {
                console.error("ç™»å½•å“åº”è§£æå¤±è´¥:", parseErr);
                reject(new Error(`å“åº”è§£æé”™è¯¯ï¼š${parseErr.message}ï¼ŒåŸå§‹å“åº”: ${response.text()}`));
            }
        });
    });
}

// ä¸»é€»è¾‘ï¼ˆä¼˜åŒ–Tokenæœ‰æ•ˆæ€§æ ¡éªŒï¼Œé¿å…è¯¯åˆ¤ï¼‰
(async () => {
    const currentTime = new Date().getTime();

    // æ ¡éªŒTokenæ˜¯å¦æœ‰æ•ˆï¼šä¸å­˜åœ¨ æˆ– å·²è¿‡æœŸï¼ˆNumberç±»å‹æ¯”è¾ƒï¼Œæ— ç±»å‹é”™è¯¯ï¼‰
    if (!accessToken || accessTokenExpires <= currentTime) {
        console.log(`âš ï¸ Tokenæ— æ•ˆï¼š${!accessToken ? "Tokenä¸å­˜åœ¨" : 
            `Tokenå·²è¿‡æœŸï¼ˆå½“å‰æ—¶é—´ï¼š${new Date(currentTime).toLocaleString()}ï¼Œè¿‡æœŸæ—¶é—´ï¼š${new Date(accessTokenExpires).toLocaleString()}`
        }`);
        await sendLoginRequest(); // ç­‰å¾…ç™»å½•å®Œæˆï¼Œç¡®ä¿Tokenåˆ·æ–°åå†å‘è¯·æ±‚
    } else {
        // æé†’Tokenå³å°†è¿‡æœŸï¼ˆå‰©ä½™æ—¶é—´<5åˆ†é’Ÿæ—¶ï¼‰
        const remainingTime = (accessTokenExpires - currentTime) / 1000; // å‰©ä½™ç§’æ•°
        if (remainingTime < 300) {
            console.log(`âš ï¸ è­¦å‘Šï¼šTokenå³å°†è¿‡æœŸï¼Œå‰©ä½™${Math.ceil(remainingTime)}ç§’ï¼Œä¸‹æ¬¡è¯·æ±‚å°†è‡ªåŠ¨åˆ·æ–°`);
        } else {
            console.log(`âœ… Tokenæœ‰æ•ˆï¼Œå‰©ä½™${Math.ceil(remainingTime / 60)}åˆ†é’Ÿ`);
        }
    }

    // åº”ç”¨Tokenåˆ°è¯·æ±‚å¤´ï¼ˆé¿å…é‡å¤æ·»åŠ ï¼‰
    const finalToken = pm.environment.get("ACCESS_TOKEN");
    if (finalToken) {
        pm.request.headers.remove("Authorization");
        pm.request.headers.add({
            key: "Authorization",
            value: finalToken // è‹¥æ¥å£è¦æ±‚Beareræ ¼å¼ï¼Œæ”¹ä¸º `Bearer ${finalToken}`ï¼ˆæ ¹æ®ä½ çš„æ¥å£è¦æ±‚è°ƒæ•´ï¼‰
        });
        console.log("âœ… å·²åœ¨è¯·æ±‚å¤´è®¾ç½®Authorization Token");
    } else {
        throw new Error("âŒ æ— æœ‰æ•ˆTokenï¼Œè¯·æ±‚æ— æ³•å‘é€");
    }
})();
